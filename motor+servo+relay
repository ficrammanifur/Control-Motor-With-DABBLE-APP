#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <ESP32Servo.h>

// === LED untuk status koneksi ===
#define LED_BUILTIN 2

// === Pin Motor ===
const int in1R = 25;
const int in2R = 26;
const int enR = 33;

const int in1L = 14;
const int in2L = 27;
const int enL = 12;

// === Pin Servo ===
const int SERVO_PIN = 18;    // Servo on pin 18
const int SERVO_KANAN = 55;   // Derajat servo kanan
const int SERVO_KIRI = 180;  // Derajat servo kiri
const int SERVO_DEPAN = 110; // Derajat servo depan
int servoPos = 110;          // Posisi awal servo

// === Pin Relay ===
#define PUMP_RELAY_PIN 19    // Relay on pin 19, NO, active HIGH

Servo myServo; // Objek servo

// === BLE Variables ===
BLEServer *pServer = NULL;
BLECharacteristic *pTxCharacteristic;
bool deviceConnected = false;
bool oldDeviceConnected = false;
bool lastOButtonState = false; // Track previous state of 'O' button
bool lastTriangleButtonState = false; // Track previous state of Triangle button

#define BLE_NAME "ROBOT-BLE"
#define SERVICE_UUID           "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_RX "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_TX "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

// === Fungsi Motor ===
void stopMotors();
void moveForward(int speed);
void moveBackward(int speed);
void turnRight(int speed);
void turnLeft(int speed);

// === Fungsi Servo Wave ===
void servoWave() {
  Serial.println("Starting servo wave sequence");
  myServo.write(SERVO_KIRI);  // Move to left (180°)
  Serial.println("Servo moved to left: " + String(SERVO_KIRI));
  delay(500);                // Wait 500ms
  myServo.write(SERVO_KANAN); // Move to right (0°)
  Serial.println("Servo moved to right: " + String(SERVO_KANAN));
  delay(500);                // Wait 500ms
  myServo.write(SERVO_DEPAN); // Return to center (110°)
  Serial.println("Servo returned to center: " + String(SERVO_DEPAN));
  servoPos = SERVO_DEPAN;    // Update servo position
}

// === Callback Saat Koneksi BLE Terhubung / Terputus ===
class MyServerCallbacks : public BLEServerCallbacks {
  void onConnect(BLEServer *pServer) {
    deviceConnected = true;
    digitalWrite(LED_BUILTIN, HIGH);
    Serial.println("BLE Device Connected Successfully");
  }

  void onDisconnect(BLEServer *pServer) {
    deviceConnected = false;
    digitalWrite(LED_BUILTIN, LOW);
    digitalWrite(PUMP_RELAY_PIN, LOW); // Ensure relay is off on disconnect
    Serial.println("BLE Device Disconnected");
  }
};

// === Callback Saat Data Masuk dari Aplikasi ===
class MyCallbacks : public BLECharacteristicCallbacks {
  void onWrite(BLECharacteristic *pCharacteristic) {
    String rxValue = pCharacteristic->getValue(); // Use Arduino String

    // Print received BLE data in hexadecimal
    Serial.print("Received BLE Data: ");
    for (int i = 0; i < rxValue.length(); i++) {
      Serial.print("0x");
      Serial.print((uint8_t)rxValue[i], HEX);
      Serial.print(" ");
    }
    Serial.println();

    if (rxValue.length() >= 7) {
      uint8_t buttons = rxValue[6];  // Byte ke-7 untuk motor
      uint8_t extraButtons = rxValue[5]; // Byte ke-6 untuk tombol O dan Triangle

      Serial.print("Button State (rxValue[6]): 0x");
      Serial.println(buttons, HEX);
      Serial.print("Button State (rxValue[5]): 0x");
      Serial.println(extraButtons, HEX);
      if (rxValue.length() >= 8) {
        Serial.print("rxValue[7]: 0x");
        Serial.println((uint8_t)rxValue[7], HEX);
      }

      // Motor control
      if (buttons & 0x01) {
        moveForward(200);
        Serial.println("Forward");
      } else if (buttons & 0x02) {
        moveBackward(150);
        Serial.println("Backward");
      } else if (buttons & 0x04) {
        turnLeft(150);
        Serial.println("Left");
      } else if (buttons & 0x08) {
        turnRight(150);
        Serial.println("Right");
      } else {
        stopMotors();
        Serial.println("Stop");
      }

      // Servo control saat tombol O (rxValue[5] & 0x08) ditekan
      bool currentOButtonState = (extraButtons & 0x08);
      if (currentOButtonState && !lastOButtonState) { // Detect rising edge
        servoWave(); // Perform wave sequence
      }
      lastOButtonState = currentOButtonState; // Update button state

      // Relay control saat tombol Triangle (rxValue[5] & 0x04) ditekan
      bool currentTriangleButtonState = (extraButtons & 0x04);
      if (currentTriangleButtonState && !lastTriangleButtonState) { // Detect rising edge
        digitalWrite(PUMP_RELAY_PIN, HIGH);
        Serial.println("Relay ON");
      } else if (!currentTriangleButtonState && lastTriangleButtonState) { // Detect falling edge
        digitalWrite(PUMP_RELAY_PIN, LOW);
        Serial.println("Relay OFF");
      }
      lastTriangleButtonState = currentTriangleButtonState; // Update button state
    }
  }
};

void setup() {
  Serial.begin(115200);

  // === Setup Pin Motor ===
  pinMode(enR, OUTPUT);
  pinMode(in1R, OUTPUT);
  pinMode(in2R, OUTPUT);
  pinMode(enL, OUTPUT);
  pinMode(in1L, OUTPUT);
  pinMode(in2L, OUTPUT);

  digitalWrite(enR, HIGH);
  digitalWrite(enL, HIGH);

  // === Setup Pin Servo ===
  ESP32PWM::allocateTimer(1); // Use timer 1 to avoid motor PWM conflict
  myServo.setPeriodHertz(50); // Standar 50Hz untuk servo
  if (myServo.attach(SERVO_PIN, 500, 2500)) { // Attach dengan min/max pulse width (500us, 2500us)
    Serial.println("Servo attached successfully on pin " + String(SERVO_PIN));
  } else {
    Serial.println("Failed to attach servo on pin " + String(SERVO_PIN));
  }
  myServo.write(servoPos); // Set posisi awal servo
  Serial.println("Servo initialized to: " + String(servoPos));

  // === Setup Pin Relay ===
  pinMode(PUMP_RELAY_PIN, OUTPUT);
  digitalWrite(PUMP_RELAY_PIN, LOW); // Relay off on startup
  Serial.println("Relay initialized to OFF on pin " + String(PUMP_RELAY_PIN));

  // === Setup LED Status Koneksi ===
  pinMode(LED_BUILTIN, OUTPUT);
  digitalWrite(LED_BUILTIN, LOW);

  // === BLE Setup ===
  BLEDevice::init(BLE_NAME);
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());

  BLEService *pService = pServer->createService(SERVICE_UUID);

  pTxCharacteristic = pService->createCharacteristic(
    CHARACTERISTIC_UUID_TX,
    BLECharacteristic::PROPERTY_NOTIFY
  );
  pTxCharacteristic->addDescriptor(new BLE2902());

  BLECharacteristic *pRxCharacteristic = pService->createCharacteristic(
    CHARACTERISTIC_UUID_RX,
    BLECharacteristic::PROPERTY_WRITE
  );
  pRxCharacteristic->setCallbacks(new MyCallbacks());

  pService->start();
  pServer->getAdvertising()->start();

  Serial.println("BLE Ready, waiting for connection...");
}

// === LOOP ===
void loop() {
  if (deviceConnected && !oldDeviceConnected) {
    oldDeviceConnected = true;
    Serial.println("BLE Connection Established");
  }

  if (!deviceConnected && oldDeviceConnected) {
    oldDeviceConnected = false;
    delay(500);
    pServer->startAdvertising();
    stopMotors();
    digitalWrite(PUMP_RELAY_PIN, LOW); // Ensure relay is off on disconnect
    Serial.println("BLE Connection Lost, Restarting Advertising...");
  }

  delay(10);
}

// === MOTOR CONTROL ===
void stopMotors() {
  digitalWrite(in1R, LOW); digitalWrite(in2R, LOW);
  digitalWrite(in1L, LOW); digitalWrite(in2L, LOW);
}

void moveForward(int speed) {
  digitalWrite(in1R, LOW); digitalWrite(in2R, HIGH);
  digitalWrite(in1L, LOW); digitalWrite(in2L, HIGH);
  analogWrite(enR, speed);
  analogWrite(enL, speed);
}

void moveBackward(int speed) {
  digitalWrite(in1R, HIGH); digitalWrite(in2R, LOW);
  digitalWrite(in1L, HIGH); digitalWrite(in2L, LOW);
  analogWrite(enR, speed);
  analogWrite(enL, speed);
}

void turnRight(int speed) {
  digitalWrite(in1R, HIGH); digitalWrite(in2R, LOW);
  digitalWrite(in1L, LOW);  digitalWrite(in2L, HIGH);
  analogWrite(enR, speed);
  analogWrite(enL, speed);
}

void turnLeft(int speed) {
  digitalWrite(in1R, LOW);  digitalWrite(in2R, HIGH);
  digitalWrite(in1L, HIGH); digitalWrite(in2L, LOW);
  analogWrite(enR, speed);
  analogWrite(enL, speed);
}
